<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8">
    <title>Auoi - game practices - move and jump</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="title" content="Auoi - game practices">
    <meta name="description" content="auoi game practices">
    <meta name="keyword" content="auoi">
    <meta property="og:type" content="website">
    <meta property="og:title" content="Auoi - game practices">
    <meta property="og:description" content="game practices">
    <meta property="og:image" content="https://www.auoi.net/icons/ahyane-20y-m.png">
    <meta property="og:url" content="https://www.auoi.net">
    <meta name="format-detection" content="telephone=no">

    <link rel="shortcut icon" type="image/x-icon" href="https://www.auoi.net/icons/ahyane-20y-m.png">
    <style>
        html,
        body {
            width: 100%;
            height: 100%;
            margin: 0px;
            padding: 0px;
            overflow: hidden;
        }
    </style>
</head>

<body>
    <canvas id="my-canvas" width="0" height="0" style="width: 100%; height: 100%;"></canvas>

    <script src="../components/DefaultCanvasView.js"></script>
    <script src="../components/DefaultRenderer.js"></script>
    <script>
        (function () {
            const canvas = document.querySelector("#my-canvas");
            const renderer = new DefaultRenderer();
            const canvasView = new DefaultCanvasView(canvas, renderer);

            const map = {
                loopX: true,
                gravityPerTick: 1
            };

            const testObject = {
                x: -20,
                y: 0,
                width: 40,
                height: 40,
            };

            const physics = {
                speedX: 0,
                speedY: 0,
                accelerationX: 0,
                accelerationY: 0,
                maxSpeedX: 10,
                movingPowerPerTick: 0.03,
                leftJumpingPower: 0,
                maxJumpingPower: 18,
                jumpingPowerPerTick: 3,
                jumpedAt: null,
                flapped: 0,
                flappable: 1,
                reflectionDecrement: 5,
                reflectivity: 0.4,
                groundResistivity: 0.14,
                airResistivity: 0.01,
            };

            function computeMoving(boundary, status) {
                const now = Date.now();

                if (status.keyTimes["left"]) {
                    physics.accelerationX = Math.min(physics.accelerationX - physics.movingPowerPerTick, 0);
                } else if (status.keyTimes["right"]) {
                    physics.accelerationX = Math.max(physics.accelerationX + physics.movingPowerPerTick, 0);
                } else {
                    physics.accelerationX = 0;
                    if (testObject.jumpedAt) {
                        physics.speedX += (0 - physics.speedX) * physics.airResistivity;
                    } else {
                        physics.speedX += (0 - physics.speedX) * physics.groundResistivity;
                    }
                }

                physics.speedX = Math.max(Math.min(physics.speedX + physics.accelerationX, physics.maxSpeedX), -physics.maxSpeedX);

                testObject.x += physics.speedX;
                if (map.loopX) {
                    if (testObject.x < boundary.left - testObject.width) {
                        testObject.x = boundary.right;
                    } else if (testObject.x > boundary.right) {
                        testObject.x = boundary.left - testObject.width;
                    }
                }
            }

            function computeJumping(boundary, status) {
                const now = Date.now();

                if (status.keyTimes["jump"]) {
                    if (physics.jumpedAt == null) {
                        physics.flapped = 0;
                        physics.jumpedAt = now;
                        physics.leftJumpingPower = physics.maxJumpingPower;
                        physics.accelerationY = 0;
                    } else if (physics.flapped < physics.flappable) {
                        if (status.keyTimes["jump"] > physics.jumpedAt) {
                            physics.flapped++;
                            physics.jumpedAt = now;
                            physics.leftJumpingPower = physics.maxJumpingPower;
                            physics.accelerationY = 0;
                        }
                    }
                } else {
                    physics.leftJumpingPower = 0;
                }

                if (physics.leftJumpingPower > 0) {
                    physics.accelerationY += physics.jumpingPowerPerTick;
                    physics.leftJumpingPower -= physics.jumpingPowerPerTick;
                }

                physics.speedY = -physics.accelerationY;
                physics.accelerationY = physics.accelerationY - map.gravityPerTick;

                // Check ground
                testObject.y += physics.speedY;
                if (testObject.y > 0) {
                    testObject.y = 0;
                    physics.accelerationY = Math.max((Math.abs(physics.accelerationY) - physics.reflectionDecrement) * physics.reflectivity, 0);
                    physics.jumpedAt = null;
                }
            }

            renderer.setOnComputeListener((boundary, status) => {
                computeMoving(boundary, status);
                computeJumping(boundary, status);
            });

            renderer.setOnRenderListener((context, boundary) => {
                // Ground
                context.strokeStyle = "#000000";
                context.lineWidth = 1;
                context.beginPath();
                context.moveTo(boundary.left, 0);
                context.lineTo(boundary.right, 0);
                context.stroke();
                context.closePath();

                // Text
                context.font = "20px sans-serif";
                context.textAlign = "center";
                context.textBaseline = "top";
                context.fillText("Jump!! You can move left & right and jump by arrow key and spacebar!!", 0, 20);

                // Practice objects
                context.strokeRect(testObject.x, testObject.y - testObject.height, testObject.width, testObject.height);
            });
        })();
    </script>
</body>

</html>